<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>C# 线程总结 | Ravenq 的技术博客</title>
    <meta name="description" content="Ravenq 的技术博客文章在Github的备份，博客请访问 http://www.aqcoder.com">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script src="/baidu-tongji.js"></script>
    
    <link rel="preload" href="/assets/css/0.styles.3e1d0bd1.css" as="style"><link rel="preload" href="/assets/js/app.abf0aa37.js" as="script"><link rel="preload" href="/assets/js/24.319d9cbf.js" as="script"><link rel="prefetch" href="/assets/js/10.04a127f9.js"><link rel="prefetch" href="/assets/js/11.f57d362f.js"><link rel="prefetch" href="/assets/js/12.b9f2d69c.js"><link rel="prefetch" href="/assets/js/13.35361639.js"><link rel="prefetch" href="/assets/js/14.6ab17b11.js"><link rel="prefetch" href="/assets/js/15.acb0fa69.js"><link rel="prefetch" href="/assets/js/16.32c92aa0.js"><link rel="prefetch" href="/assets/js/17.1aa8f29b.js"><link rel="prefetch" href="/assets/js/18.d87cd09d.js"><link rel="prefetch" href="/assets/js/19.d74ead15.js"><link rel="prefetch" href="/assets/js/2.81340e14.js"><link rel="prefetch" href="/assets/js/20.3a8af0fd.js"><link rel="prefetch" href="/assets/js/21.7f8ec8e4.js"><link rel="prefetch" href="/assets/js/22.96cc9f5c.js"><link rel="prefetch" href="/assets/js/23.b06791ba.js"><link rel="prefetch" href="/assets/js/25.05870f73.js"><link rel="prefetch" href="/assets/js/26.d0617a05.js"><link rel="prefetch" href="/assets/js/27.ee315cd6.js"><link rel="prefetch" href="/assets/js/28.fea456b5.js"><link rel="prefetch" href="/assets/js/29.baabe7ad.js"><link rel="prefetch" href="/assets/js/3.a03553ca.js"><link rel="prefetch" href="/assets/js/30.e20507a9.js"><link rel="prefetch" href="/assets/js/31.81c1329c.js"><link rel="prefetch" href="/assets/js/32.f9323fdf.js"><link rel="prefetch" href="/assets/js/33.4e48c8b6.js"><link rel="prefetch" href="/assets/js/34.c805e02a.js"><link rel="prefetch" href="/assets/js/35.92e5376c.js"><link rel="prefetch" href="/assets/js/36.c850653d.js"><link rel="prefetch" href="/assets/js/37.125da3ec.js"><link rel="prefetch" href="/assets/js/38.969ae7bd.js"><link rel="prefetch" href="/assets/js/39.5becbd28.js"><link rel="prefetch" href="/assets/js/4.fd104560.js"><link rel="prefetch" href="/assets/js/40.55c3c7fc.js"><link rel="prefetch" href="/assets/js/41.9842fced.js"><link rel="prefetch" href="/assets/js/42.b3226976.js"><link rel="prefetch" href="/assets/js/43.11b6bfef.js"><link rel="prefetch" href="/assets/js/44.00821b26.js"><link rel="prefetch" href="/assets/js/45.130ce022.js"><link rel="prefetch" href="/assets/js/46.72ff4400.js"><link rel="prefetch" href="/assets/js/47.d0d8b682.js"><link rel="prefetch" href="/assets/js/5.855dc9b7.js"><link rel="prefetch" href="/assets/js/6.fa7c5cbc.js"><link rel="prefetch" href="/assets/js/7.99b3f4bb.js"><link rel="prefetch" href="/assets/js/8.8cdd939f.js"><link rel="prefetch" href="/assets/js/9.491360f4.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3e1d0bd1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Ravenq 的技术博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://www.aqcoder.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/markdown-it-vue" target="_blank" rel="noopener noreferrer" class="nav-link external">
  markdown-it-vue
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/vue-cli-plugin-component-lib" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue-cli-plugin-component-lib
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><h4>GVF Project</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-server" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-server
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-client" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-client
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-admin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-admin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://www.github.com/ravenq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://www.aqcoder.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/markdown-it-vue" target="_blank" rel="noopener noreferrer" class="nav-link external">
  markdown-it-vue
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/vue-cli-plugin-component-lib" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue-cli-plugin-component-lib
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><h4>GVF Project</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-server" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-server
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-client" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-client
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-admin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-admin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://www.github.com/ravenq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>C# 线程总结</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog.md/28.html#什么是线程" class="sidebar-link">什么是线程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/28.html#时间开销" class="sidebar-link">时间开销</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/28.html#c-中使用线程的方法" class="sidebar-link">C# 中使用线程的方法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/28.html#thread" class="sidebar-link">Thread</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/28.html#threadpool" class="sidebar-link">Threadpool</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/28.html#backgroundworker" class="sidebar-link">Backgroundworker</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/28.html#task" class="sidebar-link">Task</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog.md/28.html#asynchronous-delegates" class="sidebar-link">Asynchronous Delegates</a></li></ul></li><li><a href="/blog.md/28.html#前台线程-后台线程" class="sidebar-link">前台线程 &amp; 后台线程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/28.html#线程状态" class="sidebar-link">线程状态</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/28.html#结论" class="sidebar-link">结论</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="c-线程总结"><a href="#c-线程总结" aria-hidden="true" class="header-anchor">#</a> C# 线程总结</h1> <h2 id="什么是线程"><a href="#什么是线程" aria-hidden="true" class="header-anchor">#</a> 什么是线程</h2> <p><a href="http://zh.wikipedia.org/zh-cn/%E7%BA%BF%E7%A8%8B" target="_blank" rel="noopener noreferrer">http://zh.wikipedia.org/zh-cn/线程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
线程（英语：thread）是操作系统能够进行运算调度的最小单位。它被包含在进程之中，是进程中的实际运作单位。一条线程指的是进程中一个单一顺序的控制流，一个进程中可以并发多个线程，每条线程并行执行不同的任务。在 Unix System V 及 SunOS 中也被称为轻量进程（lightweight processes），但轻量进程更多指内核线程（kernel thread），而把用户线程（user thread）称为线程。</p> <p>线程是独立调度和分派的基本单位。线程可以操作系统内核调度的内核线程，如 Win32 线程；由用户进程自行调度的用户线程，如 Linux 平台的 POSIX Thread；或者由内核与用户进程，如 Windows 7 的线程，进行混合调度。</p> <p>同一进程中的多条线程将共享该进程中的全部系统资源，如虚拟地址空间，文件描述符和信号处理等等。但同一进程中的多个线程有各自的调用栈（call stack），自己的寄存器环境（register context），自己的线程本地存储（thread-local storage）。</p> <p>一个进程可以有很多线程，每条线程并行执行不同的任务。</p> <p>在多核或多 CPU，或支持 Hyper-threading 的 CPU 上使用多线程程序设计的好处是显而易见，即提高了程序的执行吞吐率。在单 CPU 单核的计算机上，使用多线程技术，也可以把进程中负责 IO 处理、人机交互而常备阻塞的部分与密集计算的部分分开来执行，编写专门的 workhorse 线程执行密集计算，从而提高了程序的执行效率。</p> <p>ps:以上摘自 Wiki 多个平台全面解释什么是线程，加深理解。 ###空间开销
线程的空间开销来自：</p> <p>1）线程内核对象（Thread Kernel Object）。每个线程都会创建一个这样的对象，它主要包含线程上下文信息，在 32 位系统中，它所占用的内存在 700 字节左右。</p> <p>2）线程环境块（Thread Environment Block）。TEB 包括线程的异常处理链，32 位系统中占用 4KB 内存。</p> <p>3）用户模式栈（User Mode Stack），即线程栈。线程栈用于保存方法的参数、局部变量和返回值。每个线程栈占用 1024KB 的内存。要用完这些内存很简单，写一个不能结束的递归方法，让方法参数和返回值不停地消耗内存，很快就会发生 OutOfMemoryException。</p> <p>4）内核模式栈（Kernel Mode Stack）。当调用操作系统的内核模式函数时，系统会将函数参数从用户模式栈复制到内核模式栈。在 32 位系统中，内核模式栈会占用 12KB 内存。</p> <h2 id="时间开销"><a href="#时间开销" aria-hidden="true" class="header-anchor">#</a> 时间开销</h2> <p>1）线程创建的时候，系统相继初始化以上这些内存空间。</p> <p>2）接着 CLR 会调用所有加载 DLL 的 DLLMain 方法，并传递连接标志（线程终止的时候，也会调用 DLL 的 DLLMain 方法，并传递分离标志）。</p> <p>3）线程上下文切换。一个系统中会加载很多的进程，而一个进程又包含若干个线程。但是一个 CPU 在任何时候都只能有一个线程在执行。为了让每个线程看上去都在运行，系统会不断地切换“线程上下文”：每个线程大概得到几十毫秒的执行时间片，然后就会切换到下一个线程了。这个过程大概又分为以下 5 个步骤：
步骤 1: 进入内核模式。
步骤 2: 将上下文信息（主要是一些 CPU 寄存器信息）保存到正在执行的线程内核对象上。
步骤 3: 系统获取一个 Spinlock，并确定下一个要执行的线程，然后释放 Spinlock。如果下一个线程不在同一个进程内，则需要进行虚拟地址交换。
步骤 4: 从将被执行的线程内核对象上载入上下文信息。
步骤 5: 离开内核模式。</p> <hr> <h2 id="c-中使用线程的方法"><a href="#c-中使用线程的方法" aria-hidden="true" class="header-anchor">#</a> C# 中使用线程的方法</h2> <p>总结了下，C# 下使用线程有一下几种方法，个人总结有可能不全或者有些错误，请大神指教。</p> <ul><li>Thread</li> <li>Threadpool</li> <li>Backgroundworker</li> <li>Task</li> <li>Asynchronous Delegates</li></ul> <p>随着微软的 .NET 技术不断推荐，这些的线程用法也有些变化，如在 Winform 中和 WPF 中使用时可能有些区别。本文示例主要以 WPF 为准。
在介绍每种用法前先交代一下公用函数，如果觉得代码代码被切割的看不懂了，可以下载工程代码：
<a href="https://github.com/AquariusCoder/WPF-Thread-Demon" target="_blank" rel="noopener noreferrer">https://github.com/AquariusCoder/WPF-Thread-Demon<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="https://github.com/AquariusCoder/WPF-Thread-Demon.git" target="_blank" rel="noopener noreferrer">https://github.com/AquariusCoder/WPF-Thread-Demon.git<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <a href="http://download.csdn.net/detail/my___dream/8510525" target="_blank" rel="noopener noreferrer">http://download.csdn.net/detail/my___dream/8510525<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
代码很简单，一看就懂的，给我个鄙视的眼神，就可以离开了-&gt;_-&gt;
XAML</p> <div class="language-C# extra-class"><pre class="language-text"><code>&lt;Window x:Class=&quot;ThreadTest.MainWindow&quot;
  xmlns=&quot;http://schemas.microsoft.com/winfx/2006/xaml/presentation&quot;
  xmlns:x=&quot;http://schemas.microsoft.com/winfx/2006/xaml&quot;
  Title=&quot;MainWindow&quot; Height=&quot;595.773&quot; Width=&quot;887.65&quot;&gt;
  &lt;Grid&gt;
  &lt;Button x:Name=&quot;btThread&quot; Content=&quot;Thread&quot; HorizontalAlignment=&quot;Left&quot; Margin=&quot;2,0,0,531&quot; VerticalAlignment=&quot;Bottom&quot; Width=&quot;75&quot; Click=&quot;btThread_Click&quot;/&gt;
  &lt;ProgressBar x:Name=&quot;proThread&quot; HorizontalAlignment=&quot;Left&quot; Height=&quot;22&quot; Margin=&quot;202,12,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;668&quot; TextOptions.TextFormattingMode=&quot;Display&quot;/&gt;
  &lt;Button x:Name=&quot;btThreadpool&quot; Content=&quot;Threadpool&quot; HorizontalAlignment=&quot;Left&quot; Margin=&quot;0,43,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;75&quot; Click=&quot;btThreadpool_Click&quot;/&gt;
  &lt;ProgressBar x:Name=&quot;proThreadpool&quot; HorizontalAlignment=&quot;Left&quot; Height=&quot;22&quot; Margin=&quot;202,43,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;668&quot;/&gt;
  &lt;Button x:Name=&quot;btBgWorker&quot; Content=&quot;BgWorker&quot; HorizontalAlignment=&quot;Left&quot; Margin=&quot;0,75,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;75&quot; Click=&quot;btBgWorker_Click&quot;/&gt;
  &lt;ProgressBar x:Name=&quot;proBgWorker&quot; HorizontalAlignment=&quot;Left&quot; Height=&quot;22&quot; Margin=&quot;202,75,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;668&quot;/&gt;
  &lt;Button x:Name=&quot;btDelegate&quot; Content=&quot;Delegate&quot; HorizontalAlignment=&quot;Left&quot; Margin=&quot;0,106,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;75&quot; Click=&quot;btDelegate_Click&quot;/&gt;
  &lt;ProgressBar x:Name=&quot;proDelegate&quot; HorizontalAlignment=&quot;Left&quot; Height=&quot;22&quot; Margin=&quot;202,106,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;668&quot;/&gt;
  &lt;Button x:Name=&quot;btTask&quot; Content=&quot;Task&quot; HorizontalAlignment=&quot;Left&quot; Margin=&quot;0,137,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;75&quot; Click=&quot;btTask_Click&quot;/&gt;
  &lt;ProgressBar x:Name=&quot;proTask&quot; HorizontalAlignment=&quot;Left&quot; Height=&quot;22&quot; Margin=&quot;202,137,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;668&quot;/&gt;
  &lt;Label x:Name=&quot;lbThread&quot; Content=&quot;线程 Id:&quot; HorizontalAlignment=&quot;Left&quot; Margin=&quot;96,13,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;101&quot;/&gt;
  &lt;Label x:Name=&quot;lbThreadpool&quot; Content=&quot;线程 Id:&quot; HorizontalAlignment=&quot;Left&quot; Margin=&quot;96,44,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;101&quot;/&gt;
  &lt;Label x:Name=&quot;lbBgWorker&quot; Content=&quot;线程 Id:&quot; HorizontalAlignment=&quot;Left&quot; Margin=&quot;96,75,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;101&quot;/&gt;
  &lt;Label x:Name=&quot;lbDelegate&quot; Content=&quot;线程 Id:&quot; HorizontalAlignment=&quot;Left&quot; Margin=&quot;96,106,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;101&quot;/&gt;
  &lt;Label x:Name=&quot;lbTask&quot; Content=&quot;线程 Id:&quot; HorizontalAlignment=&quot;Left&quot; Margin=&quot;96,135,0,0&quot; VerticalAlignment=&quot;Top&quot; Width=&quot;101&quot;/&gt;
  &lt;/Grid&gt;
&lt;/Window&gt;
</code></pre></div><p>C# 代码</p> <div class="language-C# extra-class"><pre class="language-text"><code>private void AsyncProgressBar(ProgressBar proBar)
{
// do some thing asynchrouse
int val = 0;
while (true)
{
    // 线程内不能直接访问 UI 对象，需要使用 Invoke 或者 BeginInvoke
    object[] args = new object[2];
    args[0] = proBar;
    args[1] = val++;
    Dispatcher.BeginInvoke(new GoProgressHandle(GoProgress), args);
    if (val &gt;= 100)
    val = 0;
    System.Threading.Thread.Sleep(100);
}
}
private void GoProgress(ProgressBar proBar, int val)
{
    proBar.Value = val;
}
private void ShowThreadId(Label lb)
{
    object[] args = new object[2];
    args[0] = lb;
    args[1] = System.AppDomain.GetCurrentThreadId();
    Dispatcher.BeginInvoke(new ShowThreadIdHandle(ShowThreadId_Invoke), args);
}
private void ShowThreadId_Invoke(Label lb, int id)
{
    lb.Content = string.Format(&quot;线程 Id：{0}&quot;, id);
}
</code></pre></div><h2 id="thread"><a href="#thread" aria-hidden="true" class="header-anchor">#</a> Thread</h2> <div class="language-C# extra-class"><pre class="language-text"><code>private void ThreadPro(object obj)
{
    ShowThreadId(this.lbThread);
    AsyncProgressBar((ProgressBar)obj);
}
System.Threading.Thread t = new System.Threading.Threa(new System.Threading.ParameterizedThreadStar(ThreadPro));
t.Start(this.proThread);
</code></pre></div><p>Thread 执行完成之后变成 DeathThread 等待垃圾回收。所以如果你的程序会产生很多线程还是用线程池吧，不然你这么虐待她，当心她死给你看。</p> <h2 id="threadpool"><a href="#threadpool" aria-hidden="true" class="header-anchor">#</a> Threadpool</h2> <div class="language-C# extra-class"><pre class="language-text"><code>private void ThreadpoolPro(object state)
{
    ShowThreadId(this.lbThreadpool);
    AsyncProgressBar(this.proThreadpool);
}
private void btThreadpool_Click(object sender,RoutedEventArgs e)
{
    // 排队任务，线程池有空线程时进入线程函数
    System.Threading.ThreadPool.QueueUserWorkItem(new    System.Threading.WaitCallback(ThreadpoolPro));
}
</code></pre></div><p>线程池是为突然大量爆发的线程设计的，通过有限的几个固定线程为大量的操作服务，减少了创建和销毁线程所需的时间，从而提高效率。注意 QueueUserWorkItem 函数调用后只是进入排队队列，等待线程池有空闲线程时接管。
所以，什么时候用 Thread 什么时候用 Threadpool 就很明了了。</p> <h2 id="backgroundworker"><a href="#backgroundworker" aria-hidden="true" class="header-anchor">#</a> Backgroundworker</h2> <div class="language-C# extra-class"><pre class="language-text"><code>System.ComponentModel.BackgroundWorker bgWorker = newSystem.ComponentModel.BackgroundWorker();
public MainWindow()
{
    InitializeComponent();
    this.bgWorker.DoWork += bgWorker_DoWork; // 不可以注册多次
}
private void bgWorker_DoWork(object sender,System.ComponentModel.DoWorkEventArgs e)
{
    ShowThreadId(this.lbBgWorker);
        AsyncProgressBar(this.proBgWorker);
}
private void btBgWorker_Click(object sender,RoutedEventArgs e)
{
    if (this.bgWorker.IsBusy)
        return;
    this.bgWorker.RunWorkerAsync();
    // bgWorker 可以在线程函数中直接调用 ReportProgress 当然要先注册事件响应函数
    // this.bgWorker.ProgressChanged += bgWorker_ProgressChanged;
    // bgWorker.ReportProgress
}
</code></pre></div><p>内部使用 Threadpool 实现，实现了 IComponentModel 接口，封装了进度报告等 UI 相关事件，方便 UI 相关编程。</p> <h2 id="task"><a href="#task" aria-hidden="true" class="header-anchor">#</a> Task</h2> <div class="language-C# extra-class"><pre class="language-text"><code>    private void ThreadpoolPro(object state)
    {
        ShowThreadId(this.lbThreadpool);
        AsyncProgressBar(this.proThreadpool);
    }

    private void btTask_Click(object sender, RoutedEventArgs e)
    {
        Task tk = new Task(new Action(TaskPro));
        tk.Start();
    }
</code></pre></div><p>内部使用 Treadpool 实现。
thread 是单核多线程，task 是多核多线程。也就是说在多核的情况下使用 Task 会有一些效率的提升，具体提升情况，看具体情况了。所以使用 Thread 还是 Task 看情况而定了。注意： Task 是 .NET 4.0 新特性。</p> <h3 id="asynchronous-delegates"><a href="#asynchronous-delegates" aria-hidden="true" class="header-anchor">#</a> Asynchronous Delegates</h3> <div class="language-C# extra-class"><pre class="language-text"><code>    delegate void AsyncDelegate(ProgressBar proBar);

    private void DelegatePro(ProgressBar proBar)
    {
        ShowThreadId(this.lbDelegate);
        AsyncProgressBar(proBar);
    }

    private void btDelegate_Click(object sender, RoutedEventArgs e)
    {
        AsyncDelegate dele = new AsyncDelegate(DelegatePro);
        dele.BeginInvoke(this.proDelegate, null, null);
    }
</code></pre></div><p>内部使用 Treadpool 实现。</p> <h2 id="前台线程-后台线程"><a href="#前台线程-后台线程" aria-hidden="true" class="header-anchor">#</a> 前台线程 &amp; 后台线程</h2> <p>在 CLR(公共语言运行时)中只要有一个前台线程在运行，应用程序就是激活的，也就是说 main 函数要是提前完成了，但有一个或多个前台线程在运行，那么应用程序就是激活的。
Thread 创建的线程默认都是前台线程，可以通过 IsBackground 修改线程前后台属性。Threadpool 创建的线程都是后台线程，且不能改变。</p> <div class="language-C# extra-class"><pre class="language-text"><code>    class program
    {
        public static void Main()
        {
            Thread t = new Thread(new ThreadStart(ThreadPro));
            t.IsBackground = true; // 去掉这句，结果不一样

            Console.WriteLine(&quot;Begin Thread...&quot;);
            t.Start();
            Console.WriteLine(&quot;End Thread...&quot;);
        }

        private static void ThreadPro()
        {
            Console.WriteLine(&quot;ThreadPro...&quot;);
        }
    }
</code></pre></div><h2 id="线程状态"><a href="#线程状态" aria-hidden="true" class="header-anchor">#</a> 线程状态</h2> <p>通过 TreadStat 属性可以读取线程状态。
1）Thread.Start() 函数调用后线程处于 Unstarted 状态，只有当线程调度器分配给线程 CUP 时间后线程才进入 Runing 状态
2）Thread.Sleep() 函数调用后会使线程进入 WaitSleepJoin 状态，等待函数定义的时间后线程自动被唤醒。
3）Thread.Abort() 函数调用后会先线程发送终止请求，线程收到请求后引发 ThreadAbortException 线程捕获异常后进行清理工作(当然前提是你写了 try catch 语句)。
4）Thread.Join() 函数能使当前线程阻塞以等待工作线程任务完成。</p> <h2 id="结论"><a href="#结论" aria-hidden="true" class="header-anchor">#</a> 结论</h2> <p>1） 长时间执行繁重后台工作使用 Thread， 产生大量线程使用 Treadpool
2） UI 后台处理，并且需要反馈和控制使用 BackgroundWorker
3） Task 为 .NET 4.0 的新特性，注意版本问题，对于多核 CUP 有处理优势</p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.abf0aa37.js" defer></script><script src="/assets/js/24.319d9cbf.js" defer></script>
  </body>
</html>
