<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Gitlab Merge Request 按钮不见了 | Ravenq 的技术博客</title>
    <meta name="description" content="Ravenq 的技术博客文章在Github的备份，博客请访问 http://www.aqcoder.com">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script src="/baidu-tongji.js"></script>
    
    <link rel="preload" href="/assets/css/0.styles.3e1d0bd1.css" as="style"><link rel="preload" href="/assets/js/app.6094325c.js" as="script"><link rel="preload" href="/assets/js/40.9404e0ec.js" as="script"><link rel="prefetch" href="/assets/js/10.4f2293f7.js"><link rel="prefetch" href="/assets/js/11.d70cbb59.js"><link rel="prefetch" href="/assets/js/12.151050ff.js"><link rel="prefetch" href="/assets/js/13.98e327e5.js"><link rel="prefetch" href="/assets/js/14.52657d5b.js"><link rel="prefetch" href="/assets/js/15.f29c78b3.js"><link rel="prefetch" href="/assets/js/16.9b42233c.js"><link rel="prefetch" href="/assets/js/17.d76eead4.js"><link rel="prefetch" href="/assets/js/18.1b44fce2.js"><link rel="prefetch" href="/assets/js/19.0f22874b.js"><link rel="prefetch" href="/assets/js/2.d8f505d4.js"><link rel="prefetch" href="/assets/js/20.3a8af0fd.js"><link rel="prefetch" href="/assets/js/21.2f43bfd2.js"><link rel="prefetch" href="/assets/js/22.3badefaf.js"><link rel="prefetch" href="/assets/js/23.18fc0677.js"><link rel="prefetch" href="/assets/js/24.e105e5c1.js"><link rel="prefetch" href="/assets/js/25.cc3cb185.js"><link rel="prefetch" href="/assets/js/26.b7c250e7.js"><link rel="prefetch" href="/assets/js/27.8dd3530f.js"><link rel="prefetch" href="/assets/js/28.9d33d417.js"><link rel="prefetch" href="/assets/js/29.8f06f09e.js"><link rel="prefetch" href="/assets/js/3.c6841776.js"><link rel="prefetch" href="/assets/js/30.b023db8f.js"><link rel="prefetch" href="/assets/js/31.a90f5739.js"><link rel="prefetch" href="/assets/js/32.b6228d44.js"><link rel="prefetch" href="/assets/js/33.7e81152c.js"><link rel="prefetch" href="/assets/js/34.73fdaf57.js"><link rel="prefetch" href="/assets/js/35.199987dd.js"><link rel="prefetch" href="/assets/js/36.fc41b221.js"><link rel="prefetch" href="/assets/js/37.2b1488f7.js"><link rel="prefetch" href="/assets/js/38.5eebeb55.js"><link rel="prefetch" href="/assets/js/39.17dc21f4.js"><link rel="prefetch" href="/assets/js/4.598b8edd.js"><link rel="prefetch" href="/assets/js/41.aeac7461.js"><link rel="prefetch" href="/assets/js/42.759f2c64.js"><link rel="prefetch" href="/assets/js/43.8a83fbef.js"><link rel="prefetch" href="/assets/js/44.c62a8c24.js"><link rel="prefetch" href="/assets/js/45.a8a913c1.js"><link rel="prefetch" href="/assets/js/46.dd459ae3.js"><link rel="prefetch" href="/assets/js/47.75e748b0.js"><link rel="prefetch" href="/assets/js/48.1418afa8.js"><link rel="prefetch" href="/assets/js/49.9f022939.js"><link rel="prefetch" href="/assets/js/5.bf80c919.js"><link rel="prefetch" href="/assets/js/6.ae73b9ef.js"><link rel="prefetch" href="/assets/js/7.86c46139.js"><link rel="prefetch" href="/assets/js/8.302c640d.js"><link rel="prefetch" href="/assets/js/9.f519f576.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3e1d0bd1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Ravenq 的技术博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://www.aqcoder.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/markdown-it-vue" target="_blank" rel="noopener noreferrer" class="nav-link external">
  markdown-it-vue
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/vue-cli-plugin-component-lib" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue-cli-plugin-component-lib
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><h4>GVF Project</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-server" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-server
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-client" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-client
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-admin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-admin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://www.github.com/ravenq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://www.aqcoder.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/markdown-it-vue" target="_blank" rel="noopener noreferrer" class="nav-link external">
  markdown-it-vue
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/vue-cli-plugin-component-lib" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue-cli-plugin-component-lib
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><h4>GVF Project</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-server" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-server
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-client" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-client
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-admin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-admin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://www.github.com/ravenq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>Gitlab Merge Request 按钮不见了</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog.md/gitlab-merge-request.html#起因" class="sidebar-link">起因</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/gitlab-merge-request.html#解决过程" class="sidebar-link">解决过程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/gitlab-merge-request.html#小技巧" class="sidebar-link">小技巧</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="gitlab-merge-request-按钮不见了"><a href="#gitlab-merge-request-按钮不见了" aria-hidden="true" class="header-anchor">#</a> Gitlab Merge Request 按钮不见了</h1> <p>原文：http://www.aqcoder.com/post/46</p> <h2 id="起因"><a href="#起因" aria-hidden="true" class="header-anchor">#</a> 起因</h2> <p>因为一些原因执行了 Gitlab 恢复备份命令：</p> <div class="language-sh extra-class"><pre class="language-text"><code>gitlab-rake gitlab:backup:create   # 创建备份命令
docker exec -it gitlab  gitlab-rake gitlab:backup:create # docker 中创建备份命令

gitlab-rake gitlab:backup:restore # 恢复命令
docker exec -it gitlab gitlab-rake gitlab:backup:restore # docker 中恢复备份命令
</code></pre></div><p>恢复过程中出现了一个奇怪的错误</p> <div class="language- extra-class"><pre class="language-text"><code>NoMethodError: undefined method full_path' for nil:NilClass` encountered when restoring a backup.
</code></pre></div><p>关于这个问题的官方 issue</p> <p><a href="https://gitlab.com/gitlab-org/gitlab-foss/-/issues/35662#designs-tab" target="_blank" rel="noopener noreferrer">https://gitlab.com/gitlab-org/gitlab-foss/-/issues/35662#designs-tab<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>抱着侥幸的心理，在执行了一遍恢复命令，竟然成功了，不追究原因了。</p> <p>恢复成功后不久，就有公司小伙伴找我投诉，说明明提交了分支，在 Branchs 中都看到了分支了，</p> <p>但是就是没有 Merge Request 按钮。</p> <p><img src="https://ravenq-1251588610.cos.ap-guangzhou.myqcloud.com/gitlab-merge-request-no-found.png" alt="merge-request-not-found"></p> <h2 id="解决过程"><a href="#解决过程" aria-hidden="true" class="header-anchor">#</a> 解决过程</h2> <p>一开始没有去细想 Gitlab 系统构建的基本思路，好后悔，走了很多弯路。</p> <p>怀疑是系统恢复后 git 的某系记录不对了，其实按照 git 的设计，应该不会出现这样的问题，因为 git 是分布式设计，git 本地是完整的副本，合并的过程只不过是吧你本地的分支推送到服务器，在服务器中进行分支对比合并，所以思路就错了。</p> <p>最后细想了下 Gitlab 的系统构建路：Gitlab 是一个在 git 之上构建的一个代码管理系统，其服务器存储代码是使用 git 的存储的，然后再其上构建一个WEB 系统，记录了用户信息、工程信息、分支信息、合并记录等等。说白了就是一个使用 git 管理代码的一个WEB系统。他也有自己的数据库（PostgreSQL）和服务（使用Ruby On Rails开发）。</p> <p>那么 Gitlab 是怎么知道用户推送了 git 分支，并在界面上显示一个  Merge Request 按钮给用户的呢。</p> <p>答案是 <code>hook</code>。</p> <p>每个工程的 .git 目录下都有一个 <code>hooks</code> 文件夹，其作用就是在执行一些 git 命令的时候 git 提供的钩子脚本。</p> <p>Gitlab 就是使用了这个钩子，当用户推送了代码分支后，执行 Gitlab 预先设置的 hook，通知分支推送事件，经过一系列验证后，在用户及界面上显示一个 Merge Request 按钮。</p> <p><img src="https://ravenq-1251588610.cos.ap-guangzhou.myqcloud.com/gitlab-hooks.png" alt="gitlab-hooks"></p> <p>在 Gitlab 服务器上，我们可以找到仓库目录，并执行 ls -l 命令，查看：</p> <div class="language-sh extra-class"><pre class="language-text"><code>git@gitlab:~/git-data/repositories/myrepo.git$ ls -al
total 48
drwxr-xr-x  6 git git 4096 Apr 21 10:38 .
drwxrwx---  6 git git 4096 Apr 20 09:55 ..
-rw-r--r--  1 git git  140 Apr 21 01:40 FETCH_HEAD
-rw-r--r--  1 git git   23 Apr 20 09:55 HEAD
-rw-r--r--  1 git git  173 Apr 20 09:55 config
-rw-r--r--  1 git git   73 Apr 20 09:55 description
lrwxrwxrwx  1 git git   47 Apr 21 10:38 hooks -&gt; /opt/gitlab/embedded/service/gitlab-shell/hooks
drwxr-xr-x  2 git git 4096 Apr 20 09:55 hooks.old
drwxr-xr-x  2 git git 4096 Apr 20 09:55 info
drwxr-xr-x 51 git git 4096 Apr 21 01:46 objects
-rw-r--r--  1 git git 5614 Apr 20 09:55 packed-refs
drwxr-xr-x  7 git git 4096 Apr 21 01:38 refs
</code></pre></div><p>我们可以看到一个 <code>hooks</code> 的软连接，执行了gitlab的一个目录，这个目下就是的脚本 gitlab 接收 git 推送消息的入口。</p> <p>在进入到一个没有 Merge Request 按钮的一个仓库：</p> <div class="language-sh extra-class"><pre class="language-text"><code>git@gitlab:~/git-data/repositories/my-error-repo.git$ ls -al
total 48
drwxr-xr-x  6 git git 4096 Apr 21 10:38 .
drwxrwx---  6 git git 4096 Apr 20 09:55 ..
-rw-r--r--  1 git git  140 Apr 21 01:40 FETCH_HEAD
-rw-r--r--  1 git git   23 Apr 20 09:55 HEAD
-rw-r--r--  1 git git  173 Apr 20 09:55 config
-rw-r--r--  1 git git   73 Apr 20 09:55 description
drwxr-xr-x  2 git git 4096 Apr 20 09:55 hooks
drwxr-xr-x  2 git git 4096 Apr 20 09:55 info
drwxr-xr-x 51 git git 4096 Apr 21 01:46 objects
-rw-r--r--  1 git git 5614 Apr 20 09:55 packed-refs
drwxr-xr-x  7 git git 4096 Apr 21 01:38 refs
</code></pre></div><p>我们发现软连接没有了，那么问题很明显了，<strong>就是缺失了这个软连接</strong>。</p> <p>经过查阅一些资料，其实 GitLab 有提供相关工具命令，来检测和修复这些问题：</p> <div class="language-sh extra-class"><pre class="language-text"><code>gitlab-rake gitlab:check --trace # 检测命令
</code></pre></div><div class="language-sh extra-class"><pre class="language-text"><code>[git@gitlab myrepo.git]# gitlab-rake gitlab:check --trace
** Invoke gitlab:check (first_time)
** Invoke gitlab:gitlab_shell:check (first_time)
** Invoke environment (first_time)
** Execute environment
** Execute gitlab:gitlab_shell:check
Checking GitLab Shell ...

GitLab Shell version &gt;= 5.0.0 ? ... OK (5.0.0)
Repo base directory exists?
default... yes
Repo storage directories are symlinks?
default... no
Repo paths owned by git:git?
default... yes
Repo paths access is drwxrws---?
default... yes
hooks directories in repos are links: ...
myrepo ... wrong or missing hooks
  Try fixing it:
  sudo -u git -H /opt/gitlab/embedded/service/gitlab-shell/bin/create-hooks /var/opt/gitlab/git-data/repositories # 注意这句
  Check the hooks_path in config/gitlab.yml
  Check your gitlab-shell installation
  For more information see:
  doc/install/installation.md in section &quot;GitLab Shell&quot;
  Please fix the error above and rerun the checks.
my-error-repo ... wrong or missing hooks
  Try fixing it:
  sudo -u git -H /opt/gitlab/embedded/service/gitlab-shell/bin/create-hooks /var/opt/gitlab/git-data/repositories
  Check the hooks_path in config/gitlab.yml
  Check your gitlab-shell installation
  For more information see:
  doc/install/installation.md in section &quot;GitLab Shell&quot;
  Please fix the error above and rerun the checks.
  ...
</code></pre></div><p>通过执行结果发现 GitLab 已经告诉我们问题在哪里了，并且提供了修复命令</p> <div class="language-sh extra-class"><pre class="language-text"><code>sudo -u git -H /opt/gitlab/embedded/service/gitlab-shell/bin/create-hooks /var/opt/gitlab/git-data/repositories
</code></pre></div><p>很可惜，我执行这条命令没成功，这也许也是我执行恢复命令后出现这个问题的原因吧，我猜想gitlab执行恢复命令的时候应该也有执行这条命令，只不过失败了而已。</p> <p>命令失败了没关系，我们可以手动修复。CD 到 仓库目录执行：</p> <ol><li>切换到 git 用户，注意一定要执行这句，不然创建的软连接权限不对</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>su git
</code></pre></div><p>如果你是用 docker 搭建的 GitLab 系统，可以先进入镜像：</p> <div class="language-sh extra-class"><pre class="language-text"><code>docker exec -it gitlab /bin/bash
</code></pre></div><ol start="2"><li>CD 到仓库，备份 hooks 文件夹</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>mv hooks hooks.old
</code></pre></div><ol start="3"><li>创建软连接</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks
</code></pre></div><p>在重新推送分支，发现 Merge Request 按钮回来了。</p> <h2 id="小技巧"><a href="#小技巧" aria-hidden="true" class="header-anchor">#</a> 小技巧</h2> <p>如果你的工程很多的话，可以写一个 Shell 脚本，遍历你的仓库目录，然后执行以上的步骤。</p> <p>如果你对 Shell 脚本不熟系的话，还有一个小技巧，</p> <div class="language-sh extra-class"><pre class="language-text"><code>gitlab-rake gitlab:check | grep 'wrong or missing hooks'
</code></pre></div><p>这样你就会得到有问题的仓库列表，复制到文本编辑器，批量替换下，就可以得到一个脚本了</p> <div class="language-sh extra-class"><pre class="language-text"><code>cd /var/opt/gitlab/git-data/repositories/repo1.git &amp;&amp; mv hooks hooks.old &amp;&amp; ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks
cd /var/opt/gitlab/git-data/repositories/repo2.git &amp;&amp; mv hooks hooks.old &amp;&amp; ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks
cd /var/opt/gitlab/git-data/repositories/repo3.git &amp;&amp; mv hooks hooks.old &amp;&amp; ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks
cd /var/opt/gitlab/git-data/repositories/repo4.git &amp;&amp; mv hooks hooks.old &amp;&amp; ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks
cd /var/opt/gitlab/git-data/repositories/repo5.git &amp;&amp; mv hooks hooks.old &amp;&amp; ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks
...
</code></pre></div><p>复制执行就好了。注意切换到 git 用户哦~</p> <p><img src="https://ravenq-1251588610.cos.ap-guangzhou.myqcloud.com/ravenq-qr-gray.png" alt="ravenq"></p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.6094325c.js" defer></script><script src="/assets/js/40.9404e0ec.js" defer></script>
  </body>
</html>
