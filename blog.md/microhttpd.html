<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>libmicrohttpd 一个 C 编写的小型 HTTP 库 | Ravenq 的技术博客</title>
    <meta name="description" content="Ravenq 的技术博客文章在Github的备份，博客请访问 http://www.aqcoder.com">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script src="/baidu-tongji.js"></script>
    
    <link rel="preload" href="/assets/css/0.styles.3e1d0bd1.css" as="style"><link rel="preload" href="/assets/js/app.830fa9e8.js" as="script"><link rel="preload" href="/assets/js/43.8a83fbef.js" as="script"><link rel="prefetch" href="/assets/js/10.4f2293f7.js"><link rel="prefetch" href="/assets/js/11.d70cbb59.js"><link rel="prefetch" href="/assets/js/12.151050ff.js"><link rel="prefetch" href="/assets/js/13.98e327e5.js"><link rel="prefetch" href="/assets/js/14.52657d5b.js"><link rel="prefetch" href="/assets/js/15.f29c78b3.js"><link rel="prefetch" href="/assets/js/16.9b42233c.js"><link rel="prefetch" href="/assets/js/17.d76eead4.js"><link rel="prefetch" href="/assets/js/18.1b44fce2.js"><link rel="prefetch" href="/assets/js/19.0f22874b.js"><link rel="prefetch" href="/assets/js/2.d8f505d4.js"><link rel="prefetch" href="/assets/js/20.3a8af0fd.js"><link rel="prefetch" href="/assets/js/21.2f43bfd2.js"><link rel="prefetch" href="/assets/js/22.3badefaf.js"><link rel="prefetch" href="/assets/js/23.18fc0677.js"><link rel="prefetch" href="/assets/js/24.e105e5c1.js"><link rel="prefetch" href="/assets/js/25.cc3cb185.js"><link rel="prefetch" href="/assets/js/26.b7c250e7.js"><link rel="prefetch" href="/assets/js/27.8dd3530f.js"><link rel="prefetch" href="/assets/js/28.9d33d417.js"><link rel="prefetch" href="/assets/js/29.8f06f09e.js"><link rel="prefetch" href="/assets/js/3.c6841776.js"><link rel="prefetch" href="/assets/js/30.b023db8f.js"><link rel="prefetch" href="/assets/js/31.a90f5739.js"><link rel="prefetch" href="/assets/js/32.b6228d44.js"><link rel="prefetch" href="/assets/js/33.7e81152c.js"><link rel="prefetch" href="/assets/js/34.73fdaf57.js"><link rel="prefetch" href="/assets/js/35.199987dd.js"><link rel="prefetch" href="/assets/js/36.fc41b221.js"><link rel="prefetch" href="/assets/js/37.2b1488f7.js"><link rel="prefetch" href="/assets/js/38.5eebeb55.js"><link rel="prefetch" href="/assets/js/39.17dc21f4.js"><link rel="prefetch" href="/assets/js/4.598b8edd.js"><link rel="prefetch" href="/assets/js/40.368567a6.js"><link rel="prefetch" href="/assets/js/41.aeac7461.js"><link rel="prefetch" href="/assets/js/42.759f2c64.js"><link rel="prefetch" href="/assets/js/44.c62a8c24.js"><link rel="prefetch" href="/assets/js/45.a8a913c1.js"><link rel="prefetch" href="/assets/js/46.dd459ae3.js"><link rel="prefetch" href="/assets/js/47.75e748b0.js"><link rel="prefetch" href="/assets/js/48.1418afa8.js"><link rel="prefetch" href="/assets/js/49.9f022939.js"><link rel="prefetch" href="/assets/js/5.bf80c919.js"><link rel="prefetch" href="/assets/js/6.ae73b9ef.js"><link rel="prefetch" href="/assets/js/7.86c46139.js"><link rel="prefetch" href="/assets/js/8.302c640d.js"><link rel="prefetch" href="/assets/js/9.f519f576.js">
    <link rel="stylesheet" href="/assets/css/0.styles.3e1d0bd1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Ravenq 的技术博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="http://www.aqcoder.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/markdown-it-vue" target="_blank" rel="noopener noreferrer" class="nav-link external">
  markdown-it-vue
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/vue-cli-plugin-component-lib" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue-cli-plugin-component-lib
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><h4>GVF Project</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-server" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-server
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-client" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-client
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-admin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-admin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://www.github.com/ravenq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="http://www.aqcoder.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">开源项目</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/markdown-it-vue" target="_blank" rel="noopener noreferrer" class="nav-link external">
  markdown-it-vue
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><!----> <a href="https://www.github.com/ravenq/vue-cli-plugin-component-lib" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue-cli-plugin-component-lib
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-item"><h4>GVF Project</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-server" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-server
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-client" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-client
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li class="dropdown-subitem"><a href="https://www.github.com/ravenq/gvf-admin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  gvf-admin
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://www.github.com/ravenq" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>libmicrohttpd 一个 C 编写的小型 HTTP 库</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/blog.md/microhttpd.html#编译与安装" class="sidebar-link">编译与安装</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/microhttpd.html#简单示例" class="sidebar-link">简单示例</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/microhttpd.html#跨域问题" class="sidebar-link">跨域问题</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/microhttpd.html#post-求参数获取" class="sidebar-link">POST 求参数获取</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/microhttpd.html#应用代码" class="sidebar-link">应用代码</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/microhttpd.html#注意事项" class="sidebar-link">注意事项</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/blog.md/microhttpd.html#最后" class="sidebar-link">最后</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="libmicrohttpd-一个-c-编写的小型-http-库"><a href="#libmicrohttpd-一个-c-编写的小型-http-库" aria-hidden="true" class="header-anchor">#</a> libmicrohttpd 一个 C 编写的小型 HTTP 库</h1> <blockquote><p>原文：<a href="http://www.aqcoder.com/post/content?id=39" target="_blank" rel="noopener noreferrer">http://www.aqcoder.com/post/content?id=39<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> by ravenq</p></blockquote> <p>libmicrohttpd 是 GUN 下开源的一个小型的 HTTP 库，能够方便的嵌入到系统中。支持 HTTP 1.1 可以同时侦听多个端口，具有 select, poll, pthread, thread poo 等多种模式，库平台支持 GNU/Linux, FreeBSD, OpenBSD, NetBSD, Android, Darwin (macOS), W32, OpenIndiana/Solaris, z/OS 等。</p> <ul><li>主页： <a href="http://www.gnu.org/software/libmicrohttpd/" target="_blank" rel="noopener noreferrer">http://www.gnu.org/software/libmicrohttpd/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>Git: <a href="https://git.gnunet.org/libmicrohttpd.git" target="_blank" rel="noopener noreferrer">https://git.gnunet.org/libmicrohttpd.git<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>FTP: <a href="/blog.md/ftp://ftp.gnu.org/gnu/libmicrohttpd/">ftp://ftp.gnu.org/gnu/libmicrohttpd/</a></li></ul> <h2 id="编译与安装"><a href="#编译与安装" aria-hidden="true" class="header-anchor">#</a> 编译与安装</h2> <p>libmicrohttpd 有提供编译好的二进制，可自行下载： <a href="/blog.md/ftp://ftp.gnu.org/gnu/libmicrohttpd/">ftp://ftp.gnu.org/gnu/libmicrohttpd/</a></p> <p>官方编译版本使用的是 MT 选项，如果需要 MD，或者其他编译选项，可以下载源码，根据不同平台进行编译。</p> <h2 id="简单示例"><a href="#简单示例" aria-hidden="true" class="header-anchor">#</a> 简单示例</h2> <div class="language-C extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;microhttpd.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">define</span> PAGE &quot;&lt;html&gt;&lt;head&gt;&lt;title&gt;libmicrohttpd demo&lt;/title&gt;&quot;\
             &quot;&lt;/head&gt;&lt;body&gt;libmicrohttpd demo&lt;/body&gt;&lt;/html&gt;&quot;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ahc_echo</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> cls<span class="token punctuation">,</span>
                    <span class="token keyword">struct</span> <span class="token class-name">MHD_Connection</span> <span class="token operator">*</span> connection<span class="token punctuation">,</span>
                    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> url<span class="token punctuation">,</span>
                    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> method<span class="token punctuation">,</span>
                    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> version<span class="token punctuation">,</span>
                    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> upload_data<span class="token punctuation">,</span>
                    size_t <span class="token operator">*</span> upload_data_size<span class="token punctuation">,</span>
                    <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span> ptr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">int</span> dummy<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> page <span class="token operator">=</span> cls<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">MHD_Response</span> <span class="token operator">*</span> response<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> <span class="token string">&quot;GET&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> MHD_NO<span class="token punctuation">;</span> <span class="token comment">/* unexpected method */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>dummy <span class="token operator">!=</span> <span class="token operator">*</span>ptr<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">/* The first time only the headers are valid,
         do not respond in the first round... */</span>
      <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token operator">&amp;</span>dummy<span class="token punctuation">;</span>
      <span class="token keyword">return</span> MHD_YES<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token operator">*</span>upload_data_size<span class="token punctuation">)</span>
    <span class="token keyword">return</span> MHD_NO<span class="token punctuation">;</span> <span class="token comment">/* upload data in a GET!? */</span>
  <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* clear context pointer */</span>
  response <span class="token operator">=</span> MHD_create_response_from_buffer <span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>page<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                              <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> page<span class="token punctuation">,</span>
                                              MHD_RESPMEM_PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ret <span class="token operator">=</span> <span class="token function">MHD_queue_response</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span>
                          MHD_HTTP_OK<span class="token punctuation">,</span>
                          response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MHD_destroy_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span>
        <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">MHD_Daemon</span> <span class="token operator">*</span> d<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s PORT\n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  d <span class="token operator">=</span> <span class="token function">MHD_start_daemon</span><span class="token punctuation">(</span>MHD_USE_THREAD_PER_CONNECTION<span class="token punctuation">,</span>
                      <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      <span class="token constant">NULL</span><span class="token punctuation">,</span>
                      <span class="token constant">NULL</span><span class="token punctuation">,</span>
                      <span class="token operator">&amp;</span>ahc_echo<span class="token punctuation">,</span>
                      PAGE<span class="token punctuation">,</span>
                      MHD_OPTION_END<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> getc <span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MHD_stop_daemon</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此示例效果为访问服务器返回一个简单的页面，页面内容见 <code>PAGE</code> 宏定义。</p> <p>可以看到 libmicrohttpd 的使用很简单。 <code>MHD_start_daemon</code> 函数启动服务，并且需要一个回调入参 <code>ahc_echo</code>，注意此方法是非阻塞的，此示例使用 <code>getc</code> 函数等待用户输入终止。</p> <p><code>ahc_echo</code> 回到函数在每次请求的时候都会进入。使用 <code>MHD_create_response_from_buffer</code> 函数创建一个响应结构体，然后使用 <code>MHD_queue_response</code> 函数把响应结构推入响应队列，libmicrohttpd 会帮我们执行响应。最后使用 <code>MHD_destroy_response</code> 清理内存。</p> <p>注意此实例只能处理 GET 请求， POST 请求比较复杂，下文我们接着会介绍。</p> <h2 id="跨域问题"><a href="#跨域问题" aria-hidden="true" class="header-anchor">#</a> 跨域问题</h2> <p>现代很多应用都是前后端分离的，libmicrohttpd 可以方便的用于本地小型 httpd 服务器。可以在本地和你的应用通过 http 进行交互，你的应用甚至可以是 WEB 应用。</p> <p><img src="https://ravenq-1251588610.cos.ap-guangzhou.myqcloud.com/microhttpd-app-message.png" alt="app message"></p> <p>使用此方法可以解决 ActiveX 技术被现代浏览器禁用的问题。可以使用 libmicrohttpd 把你的 ActiveX 控件封装到本地服务里，然后使用 http 和 WEB 应用交互。</p> <p>此时会产生跨域问题。首先我们来了解下跨域访问的原理。</p> <p>浏览器在发送 POST 请求前，首先会进行一次 OPTION 预请求，OPTION 请求返回的头部信息会决定浏览器是否发送真正的 POST 请求。关键的头部信息包括：</p> <ul><li>Access-Control-Allow-Origin</li> <li>Access-Control-Allow-Headers</li> <li>Access-Control-Allow-Methods</li></ul> <p><img src="https://ravenq-1251588610.cos.ap-guangzhou.myqcloud.com/microhttpd-post-option.png" alt="post option"></p> <p>理解了原理，就好办了，我们在请求处理回调中先处理一次 OPTION 与请求。</p> <div class="language-C extra-class"><pre class="language-c"><code>response <span class="token operator">=</span> <span class="token function">MHD_create_response_from_buffer</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>METHOD_ERROR<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                            <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>METHOD_ERROR<span class="token punctuation">,</span>
                                            MHD_RESPMEM_PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">MHD_add_response_header</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">&quot;Access-Control-Allow-Origin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MHD_add_response_header</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">&quot;Access-Control-Allow-Headers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content-type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 包括你定义的额外的头部字段</span>
<span class="token function">MHD_add_response_header</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">&quot;Access-Control-Allow-Methods&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PUT,POST,GET,DELETE,OPTIONS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ret <span class="token operator">=</span> <span class="token function">MHD_queue_response</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span>
                          MHD_HTTP_NOT_ACCEPTABLE<span class="token punctuation">,</span>
                          response<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MHD_destroy_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这样，你的 HTTP 服务就可以处理跨域请求了。
注意：不能用上面的 GET 示例，应为上面的示例拦截非 GET 的所有请求。</p> <h2 id="post-求参数获取"><a href="#post-求参数获取" aria-hidden="true" class="header-anchor">#</a> POST 求参数获取</h2> <p>首先，很遗憾的 libmicrohttpd 不支持 <code>application/json</code> 格式的 post 请求，其实，他只支持两种格式的 POST 请求：</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token macro property">#<span class="token directive keyword">define</span> MHD_HTTP_POST_ENCODING_FORM_URLENCODED &quot;application/x-www-form-urlencoded&quot;</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MHD_HTTP_POST_ENCODING_MULTIPART_FORMDATA &quot;multipart/form-data&quot;</span>
</code></pre></div><p>对于这一点，我也表示很疑惑，为什么不支持 <code>application/json</code> 呢？</p> <p>不支持，就不支持吧，我们可以使用 <code>application/x-www-form-urlencoded</code> 代替，我们来看一个实例代码（代码有点长，关键位置我的写了注释了，耐心看）：</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token comment">/**
 * Data kept per request.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">Request</span>
<span class="token punctuation">{</span>
  <span class="token comment">/**
   * Post processor handling form data (IF this is
   * a POST request).
   */</span>
  <span class="token keyword">struct</span> <span class="token class-name">MHD_PostProcessor</span> <span class="token operator">*</span>pp<span class="token punctuation">;</span>

  <span class="token comment">/**
   * URL to serve in response to this POST (if this request
   * was a 'POST')
   */</span>
  <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>post_url<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 用一个 string 来存储 POST 数据，因为 POST 数据是分段进回调接收的。
   * 如果你传输的数据不是字符串，可以使用 char 数组接收。
   */</span>
  std<span class="token operator">::</span>string post_data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">post_iterator</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>cls<span class="token punctuation">,</span>
              <span class="token keyword">enum</span> <span class="token class-name">MHD_ValueKind</span> kind<span class="token punctuation">,</span>
              <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">,</span>
              <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span>
              <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>content_type<span class="token punctuation">,</span>
              <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>transfer_encoding<span class="token punctuation">,</span>
              <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> uint64_t off<span class="token punctuation">,</span> size_t size<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">Request</span> <span class="token operator">*</span>request <span class="token operator">=</span> cls<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">Session</span> <span class="token operator">*</span>session <span class="token operator">=</span> request<span class="token operator">-&gt;</span>session<span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>kind<span class="token punctuation">;</span>              <span class="token comment">/* Unused. Silent compiler warning. */</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>filename<span class="token punctuation">;</span>          <span class="token comment">/* Unused. Silent compiler warning. */</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>content_type<span class="token punctuation">;</span>      <span class="token comment">/* Unused. Silent compiler warning. */</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>transfer_encoding<span class="token punctuation">;</span> <span class="token comment">/* Unused. Silent compiler warning. */</span>

  <span class="token comment">// 这里也可以处理请求参数，但是这里会进入更多次，经我实践是没 512 个字节进入一次。</span>
  <span class="token comment">// 并且要注意，使用 application/x-www-form-urlencoded 时，POST 请求数据必须是如下格式：</span>
  <span class="token comment">// key=xxxxxxxx</span>
  <span class="token comment">// key 就是这个回调的 key 参数， xxxxxxxx 是你的请求参数。</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">handle_request</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>cls<span class="token punctuation">,</span>
                <span class="token keyword">struct</span> <span class="token class-name">MHD_Connection</span> <span class="token operator">*</span>connection<span class="token punctuation">,</span>
                <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>url<span class="token punctuation">,</span>
                <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>method<span class="token punctuation">,</span>
                <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>version<span class="token punctuation">,</span>
                <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>upload_data<span class="token punctuation">,</span>
                size_t <span class="token operator">*</span>upload_data_size<span class="token punctuation">,</span>
                <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>ptr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">MHD_Response</span> <span class="token operator">*</span>response<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">Request</span> <span class="token operator">*</span>request<span class="token punctuation">;</span>
  <span class="token keyword">struct</span> <span class="token class-name">Session</span> <span class="token operator">*</span>session<span class="token punctuation">;</span>
  <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>cls<span class="token punctuation">;</span>     <span class="token comment">/* Unused. Silent compiler warning. */</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>version<span class="token punctuation">;</span> <span class="token comment">/* Unused. Silent compiler warning. */</span>

  request <span class="token operator">=</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> request<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    request <span class="token operator">=</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">Request</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;calloc error: %s\n&quot;</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> MHD_NO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>ptr <span class="token operator">=</span> request<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> MHD_HTTP_METHOD_POST<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      request<span class="token operator">-&gt;</span>pp <span class="token operator">=</span> <span class="token function">MHD_create_post_processor</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span>
                                              <span class="token operator">&amp;</span>post_iterator<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> request<span class="token operator">-&gt;</span>pp<span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Failed to setup post processor for `%s'\n&quot;</span><span class="token punctuation">,</span>
                url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> MHD_NO<span class="token punctuation">;</span> <span class="token comment">/* internal error */</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> MHD_YES<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> MHD_HTTP_METHOD_OPTIONS<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// 允许跨域请求</span>
    <span class="token function">MHD_add_response_header</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">&quot;Access-Control-Allow-Origin&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MHD_add_response_header</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">&quot;Access-Control-Allow-Headers&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content-type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 包括你定义的额外的头部字段</span>
    <span class="token function">MHD_add_response_header</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">&quot;Access-Control-Allow-Methods&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;PUT,POST,GET,DELETE,OPTIONS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>res_get <span class="token operator">=</span> <span class="token string">&quot;you call option method.&quot;</span><span class="token punctuation">;</span>
    response <span class="token operator">=</span> <span class="token function">MHD_create_response_from_buffer</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>res_get<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                               <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>res_get<span class="token punctuation">,</span>
                                               MHD_RESPMEM_PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">MHD_queue_response</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span>
                             MHD_HTTP_OK<span class="token punctuation">,</span>
                             response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MHD_destroy_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> MHD_HTTP_METHOD_POST<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token comment">/* evaluate POST data */</span>
    <span class="token function">MHD_post_process</span><span class="token punctuation">(</span>request<span class="token operator">-&gt;</span>pp<span class="token punctuation">,</span>
                     upload_data<span class="token punctuation">,</span>
                     <span class="token operator">*</span>upload_data_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token operator">*</span>upload_data_size<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// 请求回调会进入多次，直到 POST 请求的所有数据接收完毕。</span>
      <span class="token comment">// 我们在这里拼接请求参数</span>
      request<span class="token punctuation">.</span>post_data <span class="token operator">+=</span> std<span class="token operator">::</span><span class="token function">string</span><span class="token punctuation">(</span>upload_data<span class="token punctuation">,</span> <span class="token operator">*</span>upload_data_size<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token operator">*</span>upload_data_size <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> MHD_YES<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 这里得到了完整的请求参数，可以执行你的代码逻辑</span>
    std<span class="token operator">::</span>string data <span class="token operator">=</span> request<span class="token punctuation">.</span>post_data<span class="token punctuation">;</span>
    <span class="token comment">// do somthing...</span>

    <span class="token comment">/* done with POST data, serve response */</span>
    <span class="token function">MHD_destroy_post_processor</span><span class="token punctuation">(</span>request<span class="token operator">-&gt;</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    request<span class="token operator">-&gt;</span>pp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> request<span class="token operator">-&gt;</span>post_url<span class="token punctuation">)</span>
      url <span class="token operator">=</span> request<span class="token operator">-&gt;</span>post_url<span class="token punctuation">;</span>

    <span class="token comment">// 返回最终的 POST 请求</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>res_post <span class="token operator">=</span> <span class="token string">&quot;{\&quot;result\&quot;: \&quot;success\&quot;, \&quot;message\&quot;:\&quot;you call post method.\&quot;}&quot;</span><span class="token punctuation">;</span>
    response <span class="token operator">=</span> <span class="token function">MHD_create_response_from_buffer</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>res_post<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                               <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>res_post<span class="token punctuation">,</span>
                                               MHD_RESPMEM_PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MHD_add_response_header</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> <span class="token string">&quot;content-type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;applicaton/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回格式可以是 json</span>
    ret <span class="token operator">=</span> <span class="token function">MHD_queue_response</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span>
                             MHD_HTTP_OK<span class="token punctuation">,</span>
                             response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MHD_destroy_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> MHD_HTTP_METHOD_GET<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span>
      <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> MHD_HTTP_METHOD_HEAD<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>res_get <span class="token operator">=</span> <span class="token string">&quot;you call get method.&quot;</span><span class="token punctuation">;</span>
    response <span class="token operator">=</span> <span class="token function">MHD_create_response_from_buffer</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>res_get<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                               <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>res_get<span class="token punctuation">,</span>
                                               MHD_RESPMEM_PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">MHD_queue_response</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span>
                             MHD_HTTP_OK<span class="token punctuation">,</span>
                             response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">MHD_destroy_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* unsupported HTTP method */</span>
  response <span class="token operator">=</span> <span class="token function">MHD_create_response_from_buffer</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span>METHOD_ERROR<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                             <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>METHOD_ERROR<span class="token punctuation">,</span>
                                             MHD_RESPMEM_PERSISTENT<span class="token punctuation">)</span><span class="token punctuation">;</span>

  ret <span class="token operator">=</span> <span class="token function">MHD_queue_response</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span>
                           MHD_HTTP_NOT_ACCEPTABLE<span class="token punctuation">,</span>
                           response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MHD_destroy_response</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">request_completed_callback</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>cls<span class="token punctuation">,</span>
                           <span class="token keyword">struct</span> <span class="token class-name">MHD_Connection</span> <span class="token operator">*</span>connection<span class="token punctuation">,</span>
                           <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>con_cls<span class="token punctuation">,</span>
                           <span class="token keyword">enum</span> <span class="token class-name">MHD_RequestTerminationCode</span> toe<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">Request</span> <span class="token operator">*</span>request <span class="token operator">=</span> <span class="token operator">*</span>con_cls<span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>cls<span class="token punctuation">;</span>        <span class="token comment">/* Unused. Silent compiler warning. */</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>connection<span class="token punctuation">;</span> <span class="token comment">/* Unused. Silent compiler warning. */</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>toe<span class="token punctuation">;</span>        <span class="token comment">/* Unused. Silent compiler warning. */</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> request<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> request<span class="token operator">-&gt;</span>pp<span class="token punctuation">)</span>
    <span class="token function">MHD_destroy_post_processor</span><span class="token punctuation">(</span>request<span class="token operator">-&gt;</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">free</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">MHD_Daemon</span> <span class="token operator">*</span> d<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;%s PORT\n&quot;</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  d <span class="token operator">=</span> <span class="token function">MHD_start_daemon</span><span class="token punctuation">(</span>MHD_USE_ERROR_LOG<span class="token punctuation">,</span>
                       <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                       <span class="token operator">&amp;</span>handle_request<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                       MHD_OPTION_CONNECTION_TIMEOUT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token number">15</span><span class="token punctuation">,</span>
                       MHD_OPTION_NOTIFY_COMPLETED<span class="token punctuation">,</span> <span class="token operator">&amp;</span>request_completed_callback<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                       MHD_OPTION_END<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>d <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> getc <span class="token punctuation">(</span><span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MHD_stop_daemon</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的源码关键位置我都注释了，这里稍微讲解一下。当 POST 请求数据量比较大时，请求回调函数 <code>handle_request</code> 是会进入多次来接收数据的。</p> <p>因此我们使用了一个结构体 <code>Request</code> 并使用 <code>post_data</code> 字段来存储 POST 请求数据，每次进入时拼接起来，当 <code>0 == *upload_data_size</code> 时就证明数据接收完毕了。</p> <p>同时，我还加入了官方示例的代码</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> MHD_HTTP_METHOD_POST<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  request<span class="token operator">-&gt;</span>pp <span class="token operator">=</span> <span class="token function">MHD_create_post_processor</span><span class="token punctuation">(</span>connection<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span>
                                          <span class="token operator">&amp;</span>post_iterator<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> request<span class="token operator">-&gt;</span>pp<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">&quot;Failed to setup post processor for `%s'\n&quot;</span><span class="token punctuation">,</span>
            url<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> MHD_NO<span class="token punctuation">;</span> <span class="token comment">/* internal error */</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样处理会跟多此的进入 POST 数据接收回调函数 <code>post_iterator</code>。对于很多应用场景这部分有点多余，可以去除掉。</p> <h2 id="应用代码"><a href="#应用代码" aria-hidden="true" class="header-anchor">#</a> 应用代码</h2> <p>这里假设我们的应用是一个 WEB 应用，我们使用 axios 库进行 http 请求：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token string">&quot;this is a very big string.&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> data2 <span class="token operator">=</span> <span class="token string">&quot;key=&quot;</span> <span class="token operator">+</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringfy</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token punctuation">:</span> <span class="token string">&quot;this is a very big string.&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果你要在 post_iterator 接受数据，data 要这么写</span>
axios<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:7080/&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  headers<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;Content-Type&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;application/x-www-form-urlencoded&quot;</span> <span class="token punctuation">}</span> <span class="token comment">// 这里我们使用 application/x-www-form-urlencoded 类型</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 其实接收到的是 json 字符串</span>
</code></pre></div><h2 id="注意事项"><a href="#注意事项" aria-hidden="true" class="header-anchor">#</a> 注意事项</h2> <p>有些网友在断点调试时，发现 connection 对象里有个成员 <code>read_buffer</code>，这个成员里存储了他的 POST 请求数据，那不是直接可以获取到请求数据了么。</p> <p>但发现编译报错了，因为 <code>MHD_Connection</code> 结构体根本就么有导出。于是就想到了修改源码， 修改 <code>MHD_lookup_connection_value</code> 函数，直接返回 <code>read_buffer</code> 成员数据。</p> <p>于是有了这样的修改：</p> <div class="language-C extra-class"><pre class="language-c"><code><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> MHD_lookup_connection_value <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">MHD_Connection</span> <span class="token operator">*</span>connection<span class="token punctuation">,</span> <span class="token keyword">enum</span> <span class="token class-name">MHD_ValueKind</span> kind<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>key<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">struct</span> <span class="token class-name">MHD_HTTP_Header</span> <span class="token operator">*</span>pos<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">==</span> connection<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>kind <span class="token operator">==</span> MHD_POSTDATA_KIND<span class="token punctuation">)</span> <span class="token keyword">return</span> connection<span class="token operator">-&gt;</span>read_buffer<span class="token punctuation">;</span><span class="token comment">//只需要添加改行代码即可</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span>pos <span class="token operator">=</span> connection<span class="token operator">-&gt;</span>headers_received<span class="token punctuation">;</span> <span class="token constant">NULL</span> <span class="token operator">!=</span> pos<span class="token punctuation">;</span> pos <span class="token operator">=</span> pos<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>pos<span class="token operator">-&gt;</span>kind <span class="token operator">&amp;</span> kind<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> pos<span class="token operator">-&gt;</span>header<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> pos<span class="token operator">-&gt;</span>header<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token constant">NULL</span> <span class="token operator">!=</span> key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> strcasecmp <span class="token punctuation">(</span>key<span class="token punctuation">,</span> pos<span class="token operator">-&gt;</span>header<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">return</span> pos<span class="token operator">-&gt;</span>value<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>这样做是不行的</strong> <strong>这样做是不行的</strong> <strong>这样做是不行的</strong></p> <p>重要的话要说三遍。为什么呢，因为 libmicrohttpd 是异步接收 POST 请求数据的，数据量小的话，调试的时候可以看到你的 POST 请求数据，但是数据量一大，你看到的可能是部分数据，或者是空。</p> <h2 id="最后"><a href="#最后" aria-hidden="true" class="header-anchor">#</a> 最后</h2> <p>libmicrohttpd 还可以做很多事情，但是，我这里要推荐另外一个库，由 Microsoft 开源提供：<a href="https://github.com/Microsoft/cpprestsdk" target="_blank" rel="noopener noreferrer">https://github.com/Microsoft/cpprestsdk<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>这个库我也在研究单中，它用来做 REST 风格的 http 服务器应该会更加的简单，然后原生支持 <code>application/json</code> 数据格式了。</p> <p><img src="https://ravenq-1251588610.cos.ap-guangzhou.myqcloud.com/ravenq-qr-gray.png" alt="ravenq"></p></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/app.830fa9e8.js" defer></script><script src="/assets/js/43.8a83fbef.js" defer></script>
  </body>
</html>
