(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{206:function(t,e,s){"use strict";s.r(e);var r=s(0),i=Object(r.a)({},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"content"},[t._m(0),t._v(" "),t._m(1),t._v(" "),s("p",[t._v("因为一些原因执行了 Gitlab 恢复备份命令：")]),t._v(" "),t._m(2),s("p",[t._v("恢复过程中出现了一个奇怪的错误")]),t._v(" "),t._m(3),s("p",[t._v("关于这个问题的官方 issue")]),t._v(" "),s("p",[s("a",{attrs:{href:"https://gitlab.com/gitlab-org/gitlab-foss/-/issues/35662#designs-tab",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://gitlab.com/gitlab-org/gitlab-foss/-/issues/35662#designs-tab"),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("抱着侥幸的心理，在执行了一遍恢复命令，竟然成功了，不追究原因了。")]),t._v(" "),s("p",[t._v("恢复成功后不久，就有公司小伙伴找我投诉，说明明提交了分支，在 Branchs 中都看到了分支了，")]),t._v(" "),s("p",[t._v("但是就是没有 Merge Request 按钮。")]),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),s("p",[t._v("一开始没有去细想 Gitlab 系统构建的基本思路，好后悔，走了很多弯路。")]),t._v(" "),s("p",[t._v("怀疑是系统恢复后 git 的某系记录不对了，其实按照 git 的设计，应该不会出现这样的问题，因为 git 是分布式设计，git 本地是完整的副本，合并的过程只不过是吧你本地的分支推送到服务器，在服务器中进行分支对比合并，所以思路就错了。")]),t._v(" "),s("p",[t._v("最后细想了下 Gitlab 的系统构建路：Gitlab 是一个在 git 之上构建的一个代码管理系统，其服务器存储代码是使用 git 的存储的，然后再其上构建一个WEB 系统，记录了用户信息、工程信息、分支信息、合并记录等等。说白了就是一个使用 git 管理代码的一个WEB系统。他也有自己的数据库（PostgreSQL）和服务（使用Ruby On Rails开发）。")]),t._v(" "),s("p",[t._v("那么 Gitlab 是怎么知道用户推送了 git 分支，并在界面上显示一个  Merge Request 按钮给用户的呢。")]),t._v(" "),t._m(6),t._v(" "),t._m(7),t._v(" "),s("p",[t._v("Gitlab 就是使用了这个钩子，当用户推送了代码分支后，执行 Gitlab 预先设置的 hook，通知分支推送事件，经过一系列验证后，在用户及界面上显示一个 Merge Request 按钮。")]),t._v(" "),t._m(8),t._v(" "),s("p",[t._v("在 Gitlab 服务器上，我们可以找到仓库目录，并执行 ls -l 命令，查看：")]),t._v(" "),t._m(9),t._m(10),t._v(" "),s("p",[t._v("在进入到一个没有 Merge Request 按钮的一个仓库：")]),t._v(" "),t._m(11),t._m(12),t._v(" "),s("p",[t._v("经过查阅一些资料，其实 GitLab 有提供相关工具命令，来检测和修复这些问题：")]),t._v(" "),t._m(13),t._m(14),s("p",[t._v("通过执行结果发现 GitLab 已经告诉我们问题在哪里了，并且提供了修复命令")]),t._v(" "),t._m(15),s("p",[t._v("很可惜，我执行这条命令没成功，这也许也是我执行恢复命令后出现这个问题的原因吧，我猜想gitlab执行恢复命令的时候应该也有执行这条命令，只不过失败了而已。")]),t._v(" "),s("p",[t._v("命令失败了没关系，我们可以手动修复。CD 到 仓库目录执行：")]),t._v(" "),t._m(16),t._v(" "),t._m(17),s("p",[t._v("如果你是用 docker 搭建的 GitLab 系统，可以先进入镜像：")]),t._v(" "),t._m(18),t._m(19),t._v(" "),t._m(20),t._m(21),t._v(" "),t._m(22),s("p",[t._v("在重新推送分支，发现 Merge Request 按钮回来了。")]),t._v(" "),t._m(23),t._v(" "),s("p",[t._v("如果你的工程很多的话，可以写一个 Shell 脚本，遍历你的仓库目录，然后执行以上的步骤。")]),t._v(" "),s("p",[t._v("如果你对 Shell 脚本不熟系的话，还有一个小技巧，")]),t._v(" "),t._m(24),s("p",[t._v("这样你就会得到有问题的仓库列表，复制到文本编辑器，批量替换下，就可以得到一个脚本了")]),t._v(" "),t._m(25),s("p",[t._v("复制执行就好了。注意切换到 git 用户哦~")])])},[function(){var t=this.$createElement,e=this._self._c||t;return e("h1",{attrs:{id:"gitlab-merge-request-按钮不见了"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-merge-request-按钮不见了","aria-hidden":"true"}},[this._v("#")]),this._v(" Gitlab Merge Request 按钮不见了")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"起因"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#起因","aria-hidden":"true"}},[this._v("#")]),this._v(" 起因")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("gitlab-rake gitlab:backup:create   # 创建备份命令\ndocker exec -it gitlab  gitlab-rake gitlab:backup:create # docker 中创建备份命令\n\ngitlab-rake gitlab:backup:restore # 恢复命令\ndocker exec -it gitlab gitlab-rake gitlab:backup:restore # docker 中恢复备份命令\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("NoMethodError: undefined method full_path' for nil:NilClass` encountered when restoring a backup.\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://ravenq-1251588610.cos.ap-guangzhou.myqcloud.com/gitlab-merge-request-no-found.png",alt:"merge-request-not-found"}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"解决过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解决过程","aria-hidden":"true"}},[this._v("#")]),this._v(" 解决过程")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("答案是 "),e("code",[this._v("hook")]),this._v("。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("每个工程的 .git 目录下都有一个 "),e("code",[this._v("hooks")]),this._v(" 文件夹，其作用就是在执行一些 git 命令的时候 git 提供的钩子脚本。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[e("img",{attrs:{src:"https://ravenq-1251588610.cos.ap-guangzhou.myqcloud.com/gitlab-hooks.png",alt:"gitlab-hooks"}})])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("git@gitlab:~/git-data/repositories/myrepo.git$ ls -al\ntotal 48\ndrwxr-xr-x  6 git git 4096 Apr 21 10:38 .\ndrwxrwx---  6 git git 4096 Apr 20 09:55 ..\n-rw-r--r--  1 git git  140 Apr 21 01:40 FETCH_HEAD\n-rw-r--r--  1 git git   23 Apr 20 09:55 HEAD\n-rw-r--r--  1 git git  173 Apr 20 09:55 config\n-rw-r--r--  1 git git   73 Apr 20 09:55 description\nlrwxrwxrwx  1 git git   47 Apr 21 10:38 hooks -> /opt/gitlab/embedded/service/gitlab-shell/hooks\ndrwxr-xr-x  2 git git 4096 Apr 20 09:55 hooks.old\ndrwxr-xr-x  2 git git 4096 Apr 20 09:55 info\ndrwxr-xr-x 51 git git 4096 Apr 21 01:46 objects\n-rw-r--r--  1 git git 5614 Apr 20 09:55 packed-refs\ndrwxr-xr-x  7 git git 4096 Apr 21 01:38 refs\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("我们可以看到一个 "),e("code",[this._v("hooks")]),this._v(" 的软连接，执行了gitlab的一个目录，这个目下就是的脚本 gitlab 接收 git 推送消息的入口。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("git@gitlab:~/git-data/repositories/my-error-repo.git$ ls -al\ntotal 48\ndrwxr-xr-x  6 git git 4096 Apr 21 10:38 .\ndrwxrwx---  6 git git 4096 Apr 20 09:55 ..\n-rw-r--r--  1 git git  140 Apr 21 01:40 FETCH_HEAD\n-rw-r--r--  1 git git   23 Apr 20 09:55 HEAD\n-rw-r--r--  1 git git  173 Apr 20 09:55 config\n-rw-r--r--  1 git git   73 Apr 20 09:55 description\ndrwxr-xr-x  2 git git 4096 Apr 20 09:55 hooks\ndrwxr-xr-x  2 git git 4096 Apr 20 09:55 info\ndrwxr-xr-x 51 git git 4096 Apr 21 01:46 objects\n-rw-r--r--  1 git git 5614 Apr 20 09:55 packed-refs\ndrwxr-xr-x  7 git git 4096 Apr 21 01:38 refs\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("我们发现软连接没有了，那么问题很明显了，"),e("strong",[this._v("就是缺失了这个软连接")]),this._v("。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("gitlab-rake gitlab:check --trace # 检测命令\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v('[git@gitlab myrepo.git]# gitlab-rake gitlab:check --trace\n** Invoke gitlab:check (first_time)\n** Invoke gitlab:gitlab_shell:check (first_time)\n** Invoke environment (first_time)\n** Execute environment\n** Execute gitlab:gitlab_shell:check\nChecking GitLab Shell ...\n\nGitLab Shell version >= 5.0.0 ? ... OK (5.0.0)\nRepo base directory exists?\ndefault... yes\nRepo storage directories are symlinks?\ndefault... no\nRepo paths owned by git:git?\ndefault... yes\nRepo paths access is drwxrws---?\ndefault... yes\nhooks directories in repos are links: ...\nmyrepo ... wrong or missing hooks\n  Try fixing it:\n  sudo -u git -H /opt/gitlab/embedded/service/gitlab-shell/bin/create-hooks /var/opt/gitlab/git-data/repositories # 注意这句\n  Check the hooks_path in config/gitlab.yml\n  Check your gitlab-shell installation\n  For more information see:\n  doc/install/installation.md in section "GitLab Shell"\n  Please fix the error above and rerun the checks.\nmy-error-repo ... wrong or missing hooks\n  Try fixing it:\n  sudo -u git -H /opt/gitlab/embedded/service/gitlab-shell/bin/create-hooks /var/opt/gitlab/git-data/repositories\n  Check the hooks_path in config/gitlab.yml\n  Check your gitlab-shell installation\n  For more information see:\n  doc/install/installation.md in section "GitLab Shell"\n  Please fix the error above and rerun the checks.\n  ...\n')])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("sudo -u git -H /opt/gitlab/embedded/service/gitlab-shell/bin/create-hooks /var/opt/gitlab/git-data/repositories\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",[e("li",[this._v("切换到 git 用户，注意一定要执行这句，不然创建的软连接权限不对")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("su git\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("docker exec -it gitlab /bin/bash\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",{attrs:{start:"2"}},[e("li",[this._v("CD 到仓库，备份 hooks 文件夹")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("mv hooks hooks.old\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ol",{attrs:{start:"3"}},[e("li",[this._v("创建软连接")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"小技巧"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#小技巧","aria-hidden":"true"}},[this._v("#")]),this._v(" 小技巧")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("gitlab-rake gitlab:check | grep 'wrong or missing hooks'\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[this._v("cd /var/opt/gitlab/git-data/repositories/repo1.git && mv hooks hooks.old && ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks\ncd /var/opt/gitlab/git-data/repositories/repo2.git && mv hooks hooks.old && ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks\ncd /var/opt/gitlab/git-data/repositories/repo3.git && mv hooks hooks.old && ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks\ncd /var/opt/gitlab/git-data/repositories/repo4.git && mv hooks hooks.old && ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks\ncd /var/opt/gitlab/git-data/repositories/repo5.git && mv hooks hooks.old && ln -s /opt/gitlab/embedded/service/gitlab-shell/hooks hooks\n...\n")])])])}],!1,null,null,null);e.default=i.exports}}]);